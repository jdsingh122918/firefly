// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  VOLUNTEER
  MEMBER
}

enum FamilyRole {
  PRIMARY_CONTACT
  FAMILY_ADMIN
  MEMBER
}

enum MessageType {
  DIRECT           // Direct message between two users
  FAMILY_CHAT      // Family group chat
  ANNOUNCEMENT     // System/admin announcements
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum NotificationType {
  MESSAGE
  CARE_UPDATE
  SYSTEM_ANNOUNCEMENT
  FAMILY_ACTIVITY
  EMERGENCY_ALERT
}

// ====================================
// ASSIGNMENT SYSTEM ENUMS (Session 018)
// ====================================

enum NoteAssignmentStatus {
  ASSIGNED      // Task assigned, not started
  IN_PROGRESS   // User is working on it
  COMPLETED     // Task completed
  CANCELLED     // Assignment cancelled
}

enum AssignmentPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AssignmentStatus {
  ASSIGNED      // Task assigned, not started
  IN_PROGRESS   // User is working on it
  COMPLETED     // Task completed
  CANCELLED     // Assignment cancelled
}

enum DocumentSource {
  UPLOAD        // Uploaded specifically for this note
  LIBRARY       // Selected from existing documents
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  clerkId       String    @unique
  email         String    @unique
  firstName     String?
  lastName      String?
  role          UserRole  @default(MEMBER)
  familyId      String?   @db.ObjectId
  familyRole    FamilyRole? @default(MEMBER)
  family        Family?   @relation(fields: [familyId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  createdById   String?   @db.ObjectId
  createdBy     User?     @relation("UserCreator", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdUsers  User[]    @relation("UserCreator")
  createdFamilies Family[] @relation("FamilyCreator")
  phoneNumber   String?
  phoneVerified Boolean   @default(false)
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Message relations
  sentMessages       Message[] @relation("MessageSender")
  conversations      ConversationParticipant[]
  messageStatuses    MessageUserStatus[]
  notifications      Notification[]
  notificationPrefs  NotificationPreferences?

  // Document relations
  uploadedDocuments  Document[] @relation("DocumentUploader")

  // Tag and Category relations
  createdTags        Tag[] @relation("TagCreator")
  createdCategories  Category[] @relation("CategoryCreator")
  createdResourceTags ResourceTag[] @relation("ResourceTagCreator")

  // Forum relations (Session 010)
  createdForums      Forum[] @relation("ForumCreator")
  forumMemberships   ForumMember[] @relation("ForumMembership")
  posts              Post[] @relation("PostAuthor")
  replies            Reply[] @relation("ReplyAuthor")
  votes              Vote[] @relation("UserVotes")

  // Notes relations (Session 010)
  createdNotes       Note[] @relation("NoteCreator")
  sharedNotes        NoteShare[] @relation("SharedNotes")
  sharedNotesToOthers NoteShare[] @relation("NoteSharer")

  // Resources relations (Session 010)
  submittedResources Resource[] @relation("ResourceSubmitter")
  approvedResources  Resource[] @relation("ResourceApprover")
  resourceRatings    ResourceRating[] @relation("ResourceRatings")
  resourceShares     ResourceShare[] @relation("ResourceSharer")
  receivedResourceShares ResourceShare[] @relation("ResourceRecipient")

  // Assignment relations (Session 018)
  assignedNotes      NoteAssignment[] @relation("AssigneeNotes")
  createdAssignments NoteAssignment[] @relation("AssignerNotes")

  // Enhanced document and tag relations (Session 018)
  attachedDocuments  NoteDocument[] @relation("DocumentAttacher")
  createdNoteTags    NoteTag[] @relation("NoteTagCreator")

  // Unified Content relations (Session 022 consolidation)
  createdContent     Content[] @relation("ContentCreator")
  submittedContent   Content[] @relation("ContentSubmitter")
  approvedContent    Content[] @relation("ContentApprover")
  editedContent      Content[] @relation("ContentEditor")
  contentShares      ContentShare[] @relation("ContentShareReceiver")
  sharedContent      ContentShare[] @relation("ContentShareSender")
  contentAssignments ContentAssignment[] @relation("ContentAssignments")
  createdContentAssignments ContentAssignment[] @relation("ContentAssigner")
  completedContentAssignments ContentAssignment[] @relation("ContentAssignmentCompleter")
  contentRatings     ContentRating[] @relation("ContentRatings")
  contentDocumentAttachments ContentDocument[] @relation("ContentDocumentAttacher")

  @@index([familyId])
  @@index([role])
  @@map("users")
}

model Family {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  name             String
  description      String?
  createdById      String   @db.ObjectId
  primaryContactId String?  @db.ObjectId
  createdBy        User     @relation("FamilyCreator", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  members          User[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Message relations
  conversations    Conversation[]

  // Document relations
  documents        Document[] @relation("DocumentFamily")

  // Tag and Category relations
  tags             Tag[] @relation("TagFamily")
  categories       Category[] @relation("CategoryFamily")

  // Forum relations (Session 010)
  forums           Forum[] @relation("ForumFamily")

  // Notes relations (Session 010)
  notes            Note[] @relation("FamilyNotes")

  // Resources relations (Session 010)
  resources        Resource[] @relation("FamilyResources")

  // Unified Content relations (Session 022 consolidation)
  content          Content[] @relation("FamilyContent")

  @@index([createdById])
  @@index([primaryContactId])
  @@map("families")
}

// Conversation model - represents different types of conversations
model Conversation {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  title         String?     // Optional conversation title
  type          MessageType // DIRECT, FAMILY_CHAT, ANNOUNCEMENT, CARE_UPDATE
  familyId      String?     @db.ObjectId // For family-specific conversations
  isActive      Boolean     @default(true)
  createdBy     String      @db.ObjectId
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  family        Family?                   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  participants  ConversationParticipant[]
  messages      Message[]

  @@index([familyId])
  @@index([type])
  @@index([createdAt])
  @@map("conversations")
}

// Join table for conversation participants
model ConversationParticipant {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String       @db.ObjectId
  userId         String       @db.ObjectId
  joinedAt       DateTime     @default(now())
  leftAt         DateTime?
  canWrite       Boolean      @default(true) // Permission to send messages
  canManage      Boolean      @default(false) // Permission to manage conversation

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@map("conversation_participants")
}

// Message model - represents individual messages
model Message {
  id             String              @id @default(auto()) @map("_id") @db.ObjectId
  content        String
  conversationId String              @db.ObjectId
  senderId       String              @db.ObjectId
  replyToId      String?             @db.ObjectId // For threaded conversations
  isEdited       Boolean             @default(false)
  editedAt       DateTime?
  isDeleted      Boolean             @default(false)
  deletedAt      DateTime?
  attachments    String[]            @default([]) // File URLs/paths
  metadata       Json?               // Additional message data (mentions, formatting, etc.)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  // Relations
  conversation   Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User                @relation("MessageSender", fields: [senderId], references: [id], onDelete: NoAction)
  replyTo        Message?            @relation("MessageReply", fields: [replyToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies        Message[]           @relation("MessageReply")
  userStatuses   MessageUserStatus[]

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

// Message read status per user
model MessageUserStatus {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  messageId String        @db.ObjectId
  userId    String        @db.ObjectId
  status    MessageStatus @default(SENT)
  readAt    DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId, status])
  @@map("message_user_status")
}

// Notification system
model Notification {
  id           String           @id @default(auto()) @map("_id") @db.ObjectId
  userId       String           @db.ObjectId
  type         NotificationType
  title        String
  message      String
  data         Json?            // Additional notification data
  isRead       Boolean          @default(false)
  readAt       DateTime?
  isActionable Boolean          @default(false) // Requires user action
  actionUrl    String?          // URL for action
  expiresAt    DateTime?        // For time-sensitive notifications
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Relations
  user         User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// User notification preferences
model NotificationPreferences {
  id                     String  @id @default(auto()) @map("_id") @db.ObjectId
  userId                 String  @unique @db.ObjectId

  // Email preferences
  emailEnabled           Boolean @default(true)
  emailMessages          Boolean @default(true)
  emailCareUpdates       Boolean @default(true)
  emailAnnouncements     Boolean @default(true)
  emailFamilyActivity    Boolean @default(false)
  emailEmergencyAlerts   Boolean @default(true)

  // In-app preferences
  inAppEnabled           Boolean @default(true)
  inAppMessages          Boolean @default(true)
  inAppCareUpdates       Boolean @default(true)
  inAppAnnouncements     Boolean @default(true)
  inAppFamilyActivity    Boolean @default(true)
  inAppEmergencyAlerts   Boolean @default(true)

  // Timing preferences
  quietHoursEnabled      Boolean @default(false)
  quietHoursStart        String? // "22:00" format
  quietHoursEnd          String? // "08:00" format
  timezone               String? // User's timezone

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relations
  user                   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// Document types (Session 010: Extended for multimedia)
enum DocumentType {
  MEDICAL
  INSURANCE
  CARE_PLAN
  MEDICATION
  LEGAL
  FINANCIAL
  PERSONAL
  PHOTO
  VIDEO
  AUDIO        // Audio files (MP3, WAV, OGG, etc.) - NEW
  DOCUMENT     // General documents (PDF, Word, etc.) - NEW for clarity
  ARCHIVE      // ZIP, RAR, etc. - NEW
  OTHER
}

enum DocumentStatus {
  ACTIVE
  ARCHIVED
  DELETED
  DRAFT
  PROCESSING
}

// Resource types for tagging system
enum ResourceType {
  DOCUMENT
  MESSAGE
  FAMILY
  USER
  NOTIFICATION
  CARE_PLAN
  ACTIVITY
}

// Document model for file management
model Document {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  title            String
  description      String?
  filePath         String?        // Path to the file in storage (category/filename) - DEPRECATED, use fileData
  fileName         String         // Storage filename
  fileData         Bytes?         // Binary file data stored in database
  originalFileName String?        // Original uploaded filename
  fileSize         Int?           // File size in bytes
  mimeType         String?        // MIME type of the file
  type             DocumentType   @default(OTHER)
  status           DocumentStatus @default(ACTIVE)
  uploadedBy       String         @db.ObjectId
  familyId         String?        @db.ObjectId
  tags             String[]       @default([]) // Tags for organization

  // Multimedia metadata (Session 010: Added for audio/video support)
  duration         Float?         // Duration in seconds (for audio/video)
  width            Int?           // Width in pixels (for images/video)
  height           Int?           // Height in pixels (for images/video)
  thumbnailPath    String?        // Path to generated thumbnail
  previewPath      String?        // Path to preview/low-res version

  metadata         Json?          // Additional document metadata (bitrate, codec, etc.)
  isPublic         Boolean        @default(false) // Whether document is publicly accessible
  expiresAt        DateTime?      // For time-sensitive documents
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  uploadedByUser   User    @relation("DocumentUploader", fields: [uploadedBy], references: [id], onDelete: NoAction)
  family           Family? @relation("DocumentFamily", fields: [familyId], references: [id], onDelete: SetNull)

  // Tag relations
  resourceTags     ResourceTag[] @relation("DocumentResourceTags")

  // Forum relations (Session 010)
  postDocuments    PostDocument[] @relation("PostDocuments")
  replyDocuments   ReplyDocument[] @relation("ReplyDocuments")

  // Notes relations (Session 010)
  noteDocuments    NoteDocument[] @relation("NoteDocuments")

  // Resources relations (Session 010)
  resourceDocuments ResourceDocument[] @relation("ResourceDocuments")

  // Unified Content relations (Session 022 consolidation)
  contentDocuments  ContentDocument[] @relation("ContentDocuments")

  @@index([uploadedBy])
  @@index([familyId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([tags])
  @@map("documents")
}

// Category model for organizing tags hierarchically
model Category {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  color       String?   // Hex color code for UI display
  icon        String?   // Icon name or emoji
  parentId    String?   @db.ObjectId // For nested categories
  familyId    String?   @db.ObjectId // Family-scoped categories
  isSystemCategory Boolean @default(false) // System vs user-defined categories
  isActive    Boolean   @default(true)
  createdBy   String    @db.ObjectId
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children    Category[] @relation("CategoryHierarchy")
  family      Family?   @relation("CategoryFamily", fields: [familyId], references: [id], onDelete: SetNull)
  createdByUser User    @relation("CategoryCreator", fields: [createdBy], references: [id], onDelete: NoAction)
  tags        Tag[]     @relation("CategoryTags")

  // Notes and Resources relations (Session 010)
  notes       Note[]    @relation("NotesCategory")
  resources   Resource[] @relation("ResourcesCategory")

  // Unified Content relations (Session 022 consolidation)
  content     Content[] @relation("ContentCategory")

  @@unique([name, familyId]) // Unique category names within family scope
  @@index([familyId])
  @@index([parentId])
  @@index([createdBy])
  @@index([isActive])
  @@map("categories")
}

// Tag model for labeling resources
model Tag {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  color       String?    // Hex color code for UI display
  categoryId  String?    @db.ObjectId
  familyId    String?    @db.ObjectId // Family-scoped tags
  isSystemTag Boolean    @default(false) // System vs user-defined tags
  isActive    Boolean    @default(true)
  usageCount  Int        @default(0) // Track how many times this tag is used
  createdBy   String     @db.ObjectId
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  category    Category?  @relation("CategoryTags", fields: [categoryId], references: [id], onDelete: SetNull)
  family      Family?    @relation("TagFamily", fields: [familyId], references: [id], onDelete: SetNull)
  createdByUser User     @relation("TagCreator", fields: [createdBy], references: [id], onDelete: NoAction)
  resourceTags ResourceTag[] @relation("TagResources")

  // Enhanced relations (Session 018)
  noteTags    NoteTag[] @relation("TagNotes") // Notes using this tag

  // Unified Content relations (Session 022 consolidation)
  contentTags ContentTag[] @relation("ContentTags") // Content using this tag

  @@unique([name, familyId]) // Unique tag names within family scope
  @@index([familyId])
  @@index([categoryId])
  @@index([createdBy])
  @@index([isActive])
  @@index([usageCount])
  @@map("tags")
}

// ResourceTag model for tagging any resource type
model ResourceTag {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  resourceId   String       @db.ObjectId
  resourceType ResourceType
  tagId        String       @db.ObjectId
  createdBy    String       @db.ObjectId
  createdAt    DateTime     @default(now())

  // Relations
  tag          Tag          @relation("TagResources", fields: [tagId], references: [id], onDelete: Cascade)
  createdByUser User        @relation("ResourceTagCreator", fields: [createdBy], references: [id], onDelete: NoAction)

  // Polymorphic relations - only one will be populated based on resourceType
  document     Document?    @relation("DocumentResourceTags", fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([resourceId, resourceType, tagId]) // Prevent duplicate tags on same resource
  @@index([resourceId, resourceType])
  @@index([tagId])
  @@index([createdBy])
  @@map("resource_tags")
}

// ====================================
// FORUM SYSTEM MODELS (Session 010)
// ====================================

// Forum visibility and access control
enum ForumVisibility {
  PUBLIC       // All authenticated users can see
  FAMILY       // Limited to specific family members
  ROLE_BASED   // Limited to specific user roles
  PRIVATE      // Invite-only access
}

// Post types for different forum content
enum PostType {
  DISCUSSION   // Standard discussion post
  QUESTION     // Q&A format with best answer
  ANNOUNCEMENT // Official announcements (admin/volunteer only)
  RESOURCE     // Sharing resources and files
  POLL         // Poll/voting post (future enhancement)
}

// Vote types for posts and replies
enum VoteType {
  UPVOTE
  DOWNVOTE
}

// Forum model - main forum categories (like subreddits)
model Forum {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  description     String?
  slug            String            @unique // URL-friendly identifier (generated from title)
  icon            String?           // Emoji or icon name for UI
  color           String?           // Hex color for theming
  visibility      ForumVisibility   @default(PUBLIC)
  familyId        String?           @db.ObjectId // For family-scoped forums
  allowedRoles    String[]          @default([]) // For role-based visibility
  createdBy       String            @db.ObjectId
  moderators      String[]          @db.ObjectId // User IDs who can moderate
  rules           String?           // Forum rules/guidelines
  settings        Json?             // Forum-specific settings (theme, auto-moderation, etc.)
  isActive        Boolean           @default(true)
  isArchived      Boolean           @default(false)

  // Denormalized counts for performance
  postCount       Int               @default(0)
  memberCount     Int               @default(0)

  // Activity tracking
  lastActivityAt  DateTime          @default(now())
  lastPostAt      DateTime?
  lastPostBy      String?           @db.ObjectId

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  family          Family?           @relation("ForumFamily", fields: [familyId], references: [id], onDelete: SetNull)
  creator         User              @relation("ForumCreator", fields: [createdBy], references: [id], onDelete: NoAction)
  posts           Post[]
  members         ForumMember[]
  categories      ForumCategory[]

  @@index([familyId])
  @@index([visibility])
  @@index([isActive, isArchived])
  @@index([createdBy])
  @@index([lastActivityAt])
  @@index([postCount])
  @@map("forums")
}

// Forum categories - organize posts within forums
model ForumCategory {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  forumId     String    @db.ObjectId
  name        String
  description String?
  slug        String    // URL-friendly, unique within forum
  color       String?   // Hex color for UI theming
  icon        String?   // Icon or emoji
  order       Int       @default(0) // Display order
  postCount   Int       @default(0) // Denormalized count
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  forum       Forum     @relation(fields: [forumId], references: [id], onDelete: Cascade)
  posts       Post[]

  @@unique([forumId, slug]) // Unique slug within each forum
  @@index([forumId, order]) // For ordered listing
  @@index([forumId, isActive])
  @@map("forum_categories")
}

// Forum membership - track which users are members of which forums
model ForumMember {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  forumId         String    @db.ObjectId
  userId          String    @db.ObjectId
  role            String    @default("member") // member, moderator, admin
  joinedAt        DateTime  @default(now())
  lastViewedAt    DateTime  @default(now()) // For unread count calculation

  // Activity counters
  postCount       Int       @default(0)
  replyCount      Int       @default(0)

  // Notification preferences for this forum
  notifications   Boolean   @default(true)

  // Relations
  forum           Forum     @relation(fields: [forumId], references: [id], onDelete: Cascade)
  user            User      @relation("ForumMembership", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([forumId, userId]) // One membership per user per forum
  @@index([userId]) // For user's forum list
  @@index([forumId, role]) // For moderator queries
  @@index([lastViewedAt]) // For activity tracking
  @@map("forum_members")
}

// Post model - main content in forums
model Post {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  forumId         String         @db.ObjectId
  categoryId      String?        @db.ObjectId
  authorId        String         @db.ObjectId
  title           String
  content         String         // Markdown content
  slug            String         // URL-friendly, unique within forum
  type            PostType       @default(DISCUSSION)

  // Moderation flags
  isPinned        Boolean        @default(false) // Sticky posts
  isLocked        Boolean        @default(false) // Prevent new replies
  isDeleted       Boolean        @default(false) // Soft delete
  deletedAt       DateTime?
  deletedBy       String?        @db.ObjectId
  deleteReason    String?        // Optional deletion reason

  // Content metadata
  attachments     String[]       @default([]) // File paths/URLs
  tags            String[]       @default([]) // Post tags for filtering
  metadata        Json?          // Additional data (mentions, formatting, etc.)

  // Engagement metrics (denormalized for performance)
  viewCount       Int            @default(0)
  replyCount      Int            @default(0)
  upvoteCount     Int            @default(0)
  downvoteCount   Int            @default(0)
  score           Int            @default(0) // upvotes - downvotes

  // Activity tracking
  lastReplyAt     DateTime?
  lastReplyBy     String?        @db.ObjectId

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  editedAt        DateTime?      // Track when content was last edited

  // Relations
  forum           Forum          @relation(fields: [forumId], references: [id], onDelete: Cascade)
  category        ForumCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  author          User           @relation("PostAuthor", fields: [authorId], references: [id], onDelete: NoAction)
  replies         Reply[]
  votes           Vote[]
  documents       PostDocument[] // Link to Document model for rich file metadata

  @@unique([forumId, slug]) // Unique slug within forum
  @@index([forumId, isPinned, lastReplyAt]) // For forum post listing (pinned first)
  @@index([categoryId])
  @@index([authorId])
  @@index([createdAt])
  @@index([score]) // For sorting by popularity
  @@index([tags]) // For tag filtering
  @@index([isDeleted, isLocked])
  @@map("posts")
}

// Reply model - responses to posts (supports threading)
model Reply {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  postId        String    @db.ObjectId
  authorId      String    @db.ObjectId
  content       String    // Markdown content
  parentId      String?   @db.ObjectId // For nested replies (max 3 levels)
  depth         Int       @default(0) // Reply nesting depth (0, 1, 2)

  // File attachments
  attachments   String[]  @default([])
  metadata      Json?     // Additional data (mentions, formatting, etc.)

  // Moderation
  isDeleted     Boolean   @default(false) // Soft delete
  deletedAt     DateTime?
  deletedBy     String?   @db.ObjectId
  deleteReason  String?   // Optional deletion reason

  // Engagement metrics
  upvoteCount   Int       @default(0)
  downvoteCount Int       @default(0)
  score         Int       @default(0) // upvotes - downvotes

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  editedAt      DateTime? // Track content edits

  // Relations
  post          Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author        User      @relation("ReplyAuthor", fields: [authorId], references: [id], onDelete: NoAction)
  parent        Reply?    @relation("ReplyThread", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children      Reply[]   @relation("ReplyThread")
  votes         Vote[]
  documents     ReplyDocument[]

  @@index([postId, depth, createdAt]) // For threaded reply display
  @@index([authorId])
  @@index([parentId]) // For nested reply queries
  @@index([score]) // For sorting by popularity
  @@index([isDeleted])
  @@map("replies")
}

// Vote model - upvotes and downvotes for posts and replies
model Vote {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String    @db.ObjectId
  postId      String?   @db.ObjectId
  replyId     String?   @db.ObjectId
  voteType    VoteType
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user        User      @relation("UserVotes", fields: [userId], references: [id], onDelete: Cascade)
  post        Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
  reply       Reply?    @relation(fields: [replyId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])   // One vote per user per post
  @@unique([userId, replyId])  // One vote per user per reply
  @@index([userId])            // For user's voting history
  @@index([postId, voteType])  // For vote count calculations
  @@index([replyId, voteType]) // For vote count calculations
  @@map("votes")
}

// Junction table for Post-Document relationships
model PostDocument {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  postId      String    @db.ObjectId
  documentId  String    @db.ObjectId
  order       Int       @default(0) // Display order of attachments
  createdAt   DateTime  @default(now())

  // Relations
  post        Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  document    Document  @relation("PostDocuments", fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([postId, documentId]) // Prevent duplicate attachments
  @@index([postId, order])       // For ordered attachment display
  @@index([documentId])          // For document usage tracking
  @@map("post_documents")
}

// Junction table for Reply-Document relationships
model ReplyDocument {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  replyId     String    @db.ObjectId
  documentId  String    @db.ObjectId
  order       Int       @default(0) // Display order of attachments
  createdAt   DateTime  @default(now())

  // Relations
  reply       Reply     @relation(fields: [replyId], references: [id], onDelete: Cascade)
  document    Document  @relation("ReplyDocuments", fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([replyId, documentId]) // Prevent duplicate attachments
  @@index([replyId, order])       // For ordered attachment display
  @@index([documentId])           // For document usage tracking
  @@map("reply_documents")
}

// ====================================
// NOTES SYSTEM MODELS (Session 010)
// ====================================

// Note visibility and sharing options
enum NoteVisibility {
  PRIVATE      // Only visible to creator
  FAMILY       // Visible to family members
  SHARED       // Shared with specific users
  PUBLIC       // Visible to all authenticated users
}

// Content type discriminator for unified model
enum ContentType {
  NOTE         // Personal/collaborative notes
  RESOURCE     // Curated content library
}

// Note types for different use cases
enum NoteType {
  TEXT         // Plain text/markdown note
  CHECKLIST    // Task/checklist note
  JOURNAL      // Personal journal entry
  MEETING      // Meeting minutes/notes
  CARE_PLAN    // Care planning notes
  RESOURCE     // Resource or reference note
}

// Note model - personal and shared notes
model Note {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  content         String         // Markdown content
  type            NoteType       @default(TEXT)
  visibility      NoteVisibility @default(PRIVATE)

  // Ownership and access
  createdBy       String         @db.ObjectId
  familyId        String?        @db.ObjectId // For family-scoped notes
  sharedWith      String[]       @db.ObjectId @default([]) // User IDs for shared notes

  // Content organization
  tags            String[]       @default([]) // Note tags
  categoryId      String?        @db.ObjectId // Optional category
  attachments     String[]       @default([]) // File attachments

  // Note metadata
  isPinned        Boolean        @default(false) // Pin important notes
  isArchived      Boolean        @default(false) // Archive old notes
  isDeleted       Boolean        @default(false) // Soft delete
  deletedAt       DateTime?

  // Collaboration features
  allowComments   Boolean        @default(false) // Enable comments on note
  allowEditing    Boolean        @default(false) // Allow others to edit

  // Activity tracking
  lastEditedBy    String?        @db.ObjectId
  lastEditedAt    DateTime?
  viewCount       Int            @default(0)

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  creator         User           @relation("NoteCreator", fields: [createdBy], references: [id], onDelete: NoAction)
  family          Family?        @relation("FamilyNotes", fields: [familyId], references: [id], onDelete: SetNull)
  category        Category?      @relation("NotesCategory", fields: [categoryId], references: [id], onDelete: SetNull)
  documents       NoteDocument[] // Link to Document model
  shares          NoteShare[]    // Detailed sharing permissions

  // Enhanced relations (Session 018)
  assignments     NoteAssignment[] @relation("NoteAssignments") // Task assignments
  structuredTags  NoteTag[]        @relation("NoteStructuredTags") // Enhanced structured tags

  @@index([createdBy])
  @@index([familyId])
  @@index([visibility])
  @@index([type])
  @@index([tags])
  @@index([isPinned, isArchived, isDeleted])
  @@index([createdAt])
  @@map("notes")
}

// Note sharing with detailed permissions
model NoteShare {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  noteId      String    @db.ObjectId
  userId      String    @db.ObjectId
  canEdit     Boolean   @default(false) // Can edit the note
  canComment  Boolean   @default(true)  // Can comment on the note
  canShare    Boolean   @default(false) // Can share with others
  sharedBy    String    @db.ObjectId    // Who shared it
  sharedAt    DateTime  @default(now())

  // Relations
  note        Note      @relation(fields: [noteId], references: [id], onDelete: Cascade)
  user        User      @relation("SharedNotes", fields: [userId], references: [id], onDelete: Cascade)
  sharedByUser User     @relation("NoteSharer", fields: [sharedBy], references: [id], onDelete: NoAction)

  @@unique([noteId, userId]) // One share record per user per note
  @@index([userId])          // For user's shared notes
  @@index([sharedBy])        // For sharing history
  @@map("note_shares")
}

// Junction table for Note-Document relationships (Enhanced for dual workflow)
model NoteDocument {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  noteId      String         @db.ObjectId
  documentId  String         @db.ObjectId
  order       Int            @default(0) // Display order

  // Enhanced fields for dual workflow (Session 018)
  source      DocumentSource @default(UPLOAD) // Upload new vs select existing
  createdBy   String         @db.ObjectId     // Who attached the document
  createdAt   DateTime       @default(now())

  // Relations
  note        Note           @relation(fields: [noteId], references: [id], onDelete: Cascade)
  document    Document       @relation("NoteDocuments", fields: [documentId], references: [id], onDelete: Cascade)
  attachedBy  User           @relation("DocumentAttacher", fields: [createdBy], references: [id], onDelete: NoAction)

  @@unique([noteId, documentId])
  @@index([noteId, order])
  @@index([documentId])
  @@index([createdBy])
  @@map("note_documents")
}

// Note Assignment model - Task workflow for notes (Session 018)
model NoteAssignment {
  id            String              @id @default(auto()) @map("_id") @db.ObjectId
  noteId        String              @db.ObjectId
  assignedTo    String              @db.ObjectId
  assignedBy    String              @db.ObjectId
  status        NoteAssignmentStatus @default(ASSIGNED)
  priority      AssignmentPriority  @default(MEDIUM)

  // Assignment metadata
  dueDate       DateTime?
  completedAt   DateTime?
  notes         String?             // Assignment-specific instructions

  // Timestamps
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  // Relations
  note          Note                @relation("NoteAssignments", fields: [noteId], references: [id], onDelete: Cascade)
  assignee      User                @relation("AssigneeNotes", fields: [assignedTo], references: [id], onDelete: Cascade)
  assigner      User                @relation("AssignerNotes", fields: [assignedBy], references: [id], onDelete: NoAction)

  @@unique([noteId, assignedTo])  // One assignment per user per note
  @@index([assignedTo, status])   // For assignee's task list
  @@index([assignedBy])           // For assigner's created assignments
  @@index([noteId])               // For note's assignments
  @@index([status])               // Filter by status
  @@index([dueDate])              // Overdue assignments
  @@map("note_assignments")
}

// Junction table for Note-Tag relationships (Enhanced structured tags)
model NoteTag {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  noteId      String    @db.ObjectId
  tagId       String    @db.ObjectId
  createdBy   String    @db.ObjectId
  createdAt   DateTime  @default(now())

  // Relations
  note        Note      @relation("NoteStructuredTags", fields: [noteId], references: [id], onDelete: Cascade)
  tag         Tag       @relation("TagNotes", fields: [tagId], references: [id], onDelete: Cascade)
  createdByUser User    @relation("NoteTagCreator", fields: [createdBy], references: [id], onDelete: NoAction)

  @@unique([noteId, tagId])
  @@index([noteId])
  @@index([tagId])
  @@index([createdBy])
  @@map("note_tags")
}

// ====================================
// RESOURCES SYSTEM MODELS (Session 010)
// ====================================

// Resource types for categorization
enum ResourceContentType {
  DOCUMENT     // PDF, Word, etc.
  LINK         // External URL
  VIDEO        // Video file or embedded
  AUDIO        // Audio file
  IMAGE        // Image file
  TOOL         // Software tool or app
  CONTACT      // Contact information
  SERVICE      // Service provider info
}

// Resource curation status
enum ResourceStatus {
  DRAFT        // Being prepared
  PENDING      // Awaiting approval
  APPROVED     // Approved for sharing
  FEATURED     // Featured/highlighted resource
  ARCHIVED     // Archived but accessible
  REJECTED     // Rejected/not approved
}

// Resource model - curated library of helpful resources
model Resource {
  id              String              @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  description     String?
  contentType     ResourceContentType
  url             String?             // External URL (for links, videos, etc.)
  content         String?             // Rich text content

  // File attachments (for documents, images, etc.)
  attachments     String[]            @default([])

  // Organization
  categoryId      String?             @db.ObjectId
  tags            String[]            @default([])

  // Access control
  visibility      NoteVisibility      @default(PUBLIC) // Reuse visibility enum
  familyId        String?             @db.ObjectId     // Family-scoped resources
  targetAudience  String[]            @default([])     // Target user roles

  // Curation workflow
  status          ResourceStatus      @default(APPROVED)
  submittedBy     String              @db.ObjectId
  approvedBy      String?             @db.ObjectId
  approvedAt      DateTime?
  featuredBy      String?             @db.ObjectId
  featuredAt      DateTime?

  // Engagement metrics
  viewCount       Int                 @default(0)
  downloadCount   Int                 @default(0)
  shareCount      Int                 @default(0)
  rating          Float?              // Average rating (1-5)
  ratingCount     Int                 @default(0)

  // Metadata
  externalMeta    Json?               // Metadata for external resources
  isVerified      Boolean             @default(false) // Staff-verified resource
  lastVerifiedAt  DateTime?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  submitter       User                @relation("ResourceSubmitter", fields: [submittedBy], references: [id], onDelete: NoAction)
  approver        User?               @relation("ResourceApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  family          Family?             @relation("FamilyResources", fields: [familyId], references: [id], onDelete: SetNull)
  category        Category?           @relation("ResourcesCategory", fields: [categoryId], references: [id], onDelete: SetNull)
  documents       ResourceDocument[]
  ratings         ResourceRating[]
  shares          ResourceShare[]

  @@index([submittedBy])
  @@index([familyId])
  @@index([categoryId])
  @@index([contentType])
  @@index([status])
  @@index([visibility])
  @@index([tags])
  @@index([isVerified])
  @@index([rating, ratingCount]) // For sorting by rating
  @@index([viewCount])          // For sorting by popularity
  @@index([createdAt])
  @@map("resources")
}

// Resource ratings and reviews
model ResourceRating {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  resourceId  String    @db.ObjectId
  userId      String    @db.ObjectId
  rating      Int       // 1-5 stars
  review      String?   // Optional written review
  isHelpful   Boolean?  // Did this help the user
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  resource    Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  user        User      @relation("ResourceRatings", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([resourceId, userId]) // One rating per user per resource
  @@index([resourceId, rating]) // For calculating averages
  @@index([userId])             // For user's rating history
  @@map("resource_ratings")
}

// Resource sharing tracking
model ResourceShare {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  resourceId  String    @db.ObjectId
  sharedBy    String    @db.ObjectId
  sharedWith  String?   @db.ObjectId // Specific user (optional)
  shareMethod String    // 'link', 'email', 'forum_post', etc.
  shareData   Json?     // Additional share metadata
  sharedAt    DateTime  @default(now())

  // Relations
  resource    Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  sharer      User      @relation("ResourceSharer", fields: [sharedBy], references: [id], onDelete: NoAction)
  recipient   User?     @relation("ResourceRecipient", fields: [sharedWith], references: [id], onDelete: SetNull)

  @@index([resourceId]) // For resource share analytics
  @@index([sharedBy])   // For user sharing history
  @@index([sharedWith]) // For user received resources
  @@map("resource_shares")
}

// Junction table for Resource-Document relationships
model ResourceDocument {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  resourceId  String    @db.ObjectId
  documentId  String    @db.ObjectId
  order       Int       @default(0) // Display order
  isMain      Boolean   @default(false) // Main document for this resource
  createdAt   DateTime  @default(now())

  // Relations
  resource    Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  document    Document  @relation("ResourceDocuments", fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([resourceId, documentId])
  @@index([resourceId, order])
  @@index([documentId])
  @@index([isMain]) // For finding main documents
  @@map("resource_documents")
}

// Unified Content model - combines Notes and Resources
model Content {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  description     String?      // Optional description
  body            String?      // Main content (markdown/rich text)

  // Content type discriminator
  contentType     ContentType  // NOTE or RESOURCE

  // Type-specific categorization
  noteType        NoteType?    // Only for NOTE content
  resourceType    ResourceContentType? // Only for RESOURCE content

  // Shared organization fields
  visibility      NoteVisibility @default(PRIVATE)
  familyId        String?      @db.ObjectId
  categoryId      String?      @db.ObjectId
  tags            String[]     @default([])
  attachments     String[]     @default([]) // Legacy field for migration

  // Ownership and access
  createdBy       String       @db.ObjectId
  sharedWith      String[]     @db.ObjectId @default([]) // User IDs for shared content

  // Feature flags for type-specific functionality
  hasAssignments  Boolean      @default(false) // NOTE: Enable assignment features
  hasCuration     Boolean      @default(false) // RESOURCE: Enable curation workflow
  hasRatings      Boolean      @default(false) // RESOURCE: Enable rating system
  hasSharing      Boolean      @default(false) // Both: Enable advanced sharing

  // NOTE-specific fields
  isPinned        Boolean?     // Pin important notes
  isArchived      Boolean      @default(false)
  isDeleted       Boolean      @default(false)
  deletedAt       DateTime?
  allowComments   Boolean?     // Enable comments
  allowEditing    Boolean?     // Allow others to edit
  lastEditedBy    String?      @db.ObjectId
  lastEditedAt    DateTime?

  // RESOURCE-specific fields
  url             String?      // External URL for links/videos
  targetAudience  String[]     @default([]) // Target user roles
  status          ResourceStatus? // Curation workflow status
  submittedBy     String?      @db.ObjectId // Different from createdBy for resources
  approvedBy      String?      @db.ObjectId
  approvedAt      DateTime?
  featuredBy      String?      @db.ObjectId
  featuredAt      DateTime?
  isVerified      Boolean      @default(false)
  lastVerifiedAt  DateTime?
  externalMeta    Json?        // Metadata for external resources

  // Engagement metrics
  viewCount       Int          @default(0)
  downloadCount   Int          @default(0) // RESOURCE only
  shareCount      Int          @default(0) // RESOURCE only
  rating          Float?       // RESOURCE: Average rating (1-5)
  ratingCount     Int          @default(0) // RESOURCE: Number of ratings

  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations - unified from both models
  creator         User         @relation("ContentCreator", fields: [createdBy], references: [id], onDelete: NoAction)
  family          Family?      @relation("FamilyContent", fields: [familyId], references: [id], onDelete: SetNull)
  category        Category?    @relation("ContentCategory", fields: [categoryId], references: [id], onDelete: SetNull)

  // Unified document attachments
  documents       ContentDocument[] // Replaces NoteDocument + ResourceDocument

  // Content sharing (unified)
  shares          ContentShare[]    // Replaces NoteShare + ResourceShare

  // NOTE-specific relations (preserved)
  assignments     ContentAssignment[] // Renamed from NoteAssignment
  structuredTags  ContentTag[]        // Renamed from NoteTag

  // RESOURCE-specific relations (preserved)
  ratings         ContentRating[]     // Renamed from ResourceRating

  // Optional relations for legacy users during migration
  submitter       User?        @relation("ContentSubmitter", fields: [submittedBy], references: [id], onDelete: SetNull)
  approver        User?        @relation("ContentApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  lastEditor      User?        @relation("ContentEditor", fields: [lastEditedBy], references: [id], onDelete: SetNull)

  // Indexes for performance
  @@index([contentType])
  @@index([createdBy])
  @@index([familyId])
  @@index([visibility])
  @@index([noteType])
  @@index([resourceType])
  @@index([status])
  @@index([tags])
  @@index([isPinned, isArchived, isDeleted])
  @@index([rating, ratingCount]) // For resource sorting by rating
  @@index([viewCount])           // For popularity sorting
  @@index([createdAt])
  @@index([hasAssignments])      // For assignment queries
  @@index([hasCuration])         // For curation workflow
  @@index([hasRatings])          // For rating queries
  @@map("content")
}

// Unified Content-Document junction table
model ContentDocument {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  contentId   String         @db.ObjectId
  documentId  String         @db.ObjectId
  order       Int            @default(0) // Display order
  isMain      Boolean        @default(false) // Main document for this content
  source      DocumentSource @default(UPLOAD) // Upload new vs select existing
  createdBy   String         @db.ObjectId // Who attached the document
  createdAt   DateTime       @default(now())

  // Relations
  content     Content        @relation(fields: [contentId], references: [id], onDelete: Cascade)
  document    Document       @relation("ContentDocuments", fields: [documentId], references: [id], onDelete: Cascade)
  attachedBy  User           @relation("ContentDocumentAttacher", fields: [createdBy], references: [id], onDelete: NoAction)

  @@unique([contentId, documentId])
  @@index([contentId, order])
  @@index([documentId])
  @@index([isMain])
  @@map("content_documents")
}

// Unified Content sharing model
model ContentShare {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  contentId   String    @db.ObjectId
  userId      String?   @db.ObjectId // Specific user (null for public shares)
  sharedBy    String    @db.ObjectId

  // NOTE-style permission sharing
  canEdit     Boolean?  // Can edit the content (NOTE only)
  canComment  Boolean?  // Can comment (NOTE only)
  canShare    Boolean?  // Can share with others (NOTE only)

  // RESOURCE-style tracking sharing
  shareMethod String?   // 'link', 'email', 'forum_post', etc. (RESOURCE only)
  shareData   Json?     // Additional share metadata (RESOURCE only)

  sharedAt    DateTime  @default(now())

  // Relations
  content     Content   @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user        User?     @relation("ContentShareReceiver", fields: [userId], references: [id], onDelete: Cascade)
  sharer      User      @relation("ContentShareSender", fields: [sharedBy], references: [id], onDelete: NoAction)

  @@unique([contentId, userId]) // One share record per user per content (when userId specified)
  @@index([contentId])
  @@index([userId])
  @@index([sharedBy])
  @@map("content_shares")
}

// Unified Content assignments (renamed from NoteAssignment)
model ContentAssignment {
  id              String           @id @default(auto()) @map("_id") @db.ObjectId
  contentId       String           @db.ObjectId // Link to Content (NOTE type only)
  title           String
  description     String?
  priority        AssignmentPriority @default(MEDIUM)
  status          AssignmentStatus   @default(ASSIGNED)

  // Assignment details
  assignedTo      String           @db.ObjectId // User assigned to complete
  assignedBy      String           @db.ObjectId // User who assigned the task
  dueDate         DateTime?        // Optional due date
  estimatedMinutes Int?            // Estimated time to complete

  // Progress tracking
  completedAt     DateTime?        // When marked complete
  completionNotes String?          // Optional completion notes
  completedBy     String?          @db.ObjectId // Who marked it complete

  // Metadata
  tags            String[]         @default([]) // Assignment tags
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  content         Content          @relation(fields: [contentId], references: [id], onDelete: Cascade)
  assignee        User             @relation("ContentAssignments", fields: [assignedTo], references: [id], onDelete: NoAction)
  assigner        User             @relation("ContentAssigner", fields: [assignedBy], references: [id], onDelete: NoAction)
  completedByUser User?            @relation("ContentAssignmentCompleter", fields: [completedBy], references: [id], onDelete: NoAction)

  @@index([contentId])
  @@index([assignedTo, status])  // For user's assigned tasks
  @@index([assignedBy])          // For user's created assignments
  @@index([status])              // For filtering by status
  @@index([priority])            // For sorting by priority
  @@index([dueDate])            // For sorting by due date
  @@index([createdAt])
  @@map("content_assignments")
}

// Unified Content tags (renamed from NoteTag)
model ContentTag {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  contentId   String    @db.ObjectId
  tagId       String    @db.ObjectId
  createdAt   DateTime  @default(now())

  // Relations
  content     Content   @relation(fields: [contentId], references: [id], onDelete: Cascade)
  tag         Tag       @relation("ContentTags", fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([contentId, tagId])
  @@index([contentId])
  @@index([tagId])
  @@map("content_tags")
}

// Unified Content ratings (renamed from ResourceRating)
model ContentRating {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  contentId   String    @db.ObjectId
  userId      String    @db.ObjectId
  rating      Int       // 1-5 stars
  review      String?   // Optional written review
  isHelpful   Boolean?  // Did this help the user
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  content     Content   @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user        User      @relation("ContentRatings", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([contentId, userId]) // One rating per user per content
  @@index([contentId, rating]) // For calculating averages
  @@index([userId])            // For user's rating history
  @@map("content_ratings")
}